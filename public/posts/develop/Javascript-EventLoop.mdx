---
slug: Javascript-EventLoop
title: "Event Loop?"
description: "ë¹„ë™ê¸° ì²˜ë¦¬ë¥¼ ìœ„í•œ JavaScriptì˜ ì¥ì¹˜"
tags: ["javascript"]
createdAt: "2023.04.27"
---

## JavaScript ë³‘ë ¬ ì²˜ë¦¬

ì•ì— ì‘ì„±í•œ ê¸€ì„ ë‹¤ì‹œ ìƒê¸°í•˜ìë©´, JavaScriptëŠ” Single Thread ì–¸ì–´ì´ë‹¤.
í•˜ì§€ë§Œ **Event Loop**ë¥¼ ì´ìš©í•˜ì—¬ **Multi Thread ì¸ ê²ƒì²˜ëŸ¼** ë™ì‘í•  ìˆ˜ ìˆë‹¤.

### Javascript Engine

ë¸Œë¼ìš°ì €ë§ˆë‹¤ ë‹¤ë¥¸ ì—”ì§„ì„ ê°€ì§€ë©° `webkit, v8` ë“±ì´ ì¡´ì¬í•œë‹¤.
ìë°”ìŠ¤í¬ë¦½íŠ¸ ì—”ì§„ì€ <u>ìë°”ìŠ¤í¬ë¦½íŠ¸ ì½”ë“œë¥¼ í•´ì„í•˜ê³  ì‹¤í–‰í•˜ëŠ” ì¸í„°í”„ë¦¬í„°</u>ì´ë‹¤.
ì—”ì§„ì€ í¬ê²Œ **Heap**ê³¼ **Call Stack**ë¡œ ë‚˜ë‰˜ì–´ì§„ë‹¤.
Heapì—ì„œëŠ” ë©”ëª¨ë¦¬ í• ë‹¹ì´ ì¼ì–´ë‚˜ë©° ë³€ìˆ˜, ê°ì²´ ë“±ì´ ì €ì¥ë˜ëŠ” ì°½ê³ ì´ë‹¤.

### Call Stack

Call Stackì€ í•¨ìˆ˜ê°€ ì‹¤í–‰ë˜ëŠ” ìˆœì„œëŒ€ë¡œ ìŒ“ì´ëŠ” ìŠ¤íƒìœ¼ë¡œ í•¨ìˆ˜ ì‹¤í–‰ì‹œ push, ì¢…ë£Œì‹œ popëœë‹¤.

### Event Loop

Event LoopëŠ” Callback(task) Queueì—ì„œ Callback í•¨ìˆ˜ë¥¼ êº¼ë‚´ì„œ ë™ì‘ì‹œí‚¨ë‹¤.
ë¨¼ì €, Event Loopì—ì„œëŠ” ì´ë²¤íŠ¸ ë°œìƒì‹œ í˜¸ì¶œë˜ëŠ” Callback í•¨ìˆ˜ë“¤ì„ Callback Queueì— ì „ë‹¬í•œë‹¤.
ê·¸ë¦¬ê³  Call Stackê³¼ Callback Queueë¥¼ ëª¨ë‹ˆí„°ë§í•˜ë©° Call Stackì´ **ë¹„ì—ˆì„ ë•Œ**, Callback queueì˜ callback í•¨ìˆ˜ë“¤ì„ Call Stackì— ë„£ì–´ì¤€ë‹¤.

## libuv

**libuv**ëŠ” NodeJSì˜ Event Loopì— ì¡´ì¬í•˜ëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬ë¡œ, ë¹„ë™ê¸° ì…ì¶œë ¥, ì´ë²¤íŠ¸ ê¸°ë°˜ì— ì´ˆì ì„ ë§ì¶˜ ë¼ì´ë¸ŒëŸ¬ë¦¬ì´ë‹¤.
ì „í†µì ìœ¼ë¡œ IO ì²˜ë¦¬ëŠ” ìš”ì²­ë§ˆë‹¤ ìƒˆë¡œìš´ threadë¥¼ ì‚¬ìš©í•˜ì§€ë§Œ, libuvëŠ” **ë¹„ë™ê¸°, non-blocking**ìœ¼ë¡œ ì²˜ë¦¬í•œë‹¤.
ì´ë²¤íŠ¸ë¥¼ ëª¨ë‹ˆí„°ë§í•˜ë©° **node.jsê°€ libuv ìœ„ì—ì„œ ë™ì‘**í•œë‹¤.
node.jsì˜ coreëŠ” `v8 api, libuv api`ë¡œ êµ¬í˜„ë˜ì–´ ìˆë‹¤.

### ë™ì‘

- node instanceê°€ ìƒì„±ë  ë•Œ, libuvì—ëŠ” **worker thread pool**ì´ ìƒì„±ëœë‹¤.
  - worker threadëŠ” **defaultë¡œ 4ê°œ**
  - worker threadëŠ” **kernelì—ì„œ ì§€ì›í•˜ì§€ ì•ŠëŠ” ì‘ì—…ë“¤ì„ ìˆ˜í–‰**í•œë‹¤.
    - file system ê´€ë ¨ ì‘ì—… ë“±
- application ë‹¨ì—ì„œ ì½”ë“œê°€ ì‹¤í–‰ë˜ë©´ libuvê°€ í˜¸ì¶œëœë‹¤.
- libuvê°€ ë¹„ë™ê¸° ì²˜ë¦¬ë¥¼ í• ì§€, ë™ê¸° ì²˜ë¦¬ë¥¼ í• ì§€ íŒë‹¨í•œë‹¤.
- ë¹„ë™ê¸° ì‘ì—…ì´ ë“¤ì–´ì˜¤ë©´, libuvëŠ” kernel ë‹¨ì—ì„œ ë¹„ë™ê¸° í•¨ìˆ˜ë“¤ì„ í˜¸ì¶œí•˜ê±°ë‚˜ worker threadì—ê²Œ ì‘ì—…ì„ ë„˜ê²¨ì¤€ë‹¤.
- ì‘ì—…ì´ ì™„ë£Œë˜ë©´ system callì„ libuv ë‚´ì˜ Event Loopì— callbackìœ¼ë¡œ ë“±ë¡ëœë‹¤.

![javascript-runtime](/post-images/javascript/Javascript-EventLoop/1.png)
ğŸ“Œ [ì´ë¯¸ì§€ ì¶œì²˜](https://velog.io/@tastestar/Node.js-libuv)

![javascript-runtime](/post-images/javascript/Javascript-EventLoop/2.png)
ğŸ“Œ [ì´ë¯¸ì§€ ì¶œì²˜](https://sjh836.tistory.com/149)

### libuvì˜ Event Loop (in NodeJS)

![javascript-runtime](/post-images/javascript/Javascript-EventLoop/3.png)

- timers â†’ pending callbacks â†’ idle, prepare â†’ poll â†’ check â†’ close callbacks ìˆœìœ¼ë¡œ í˜¸ì¶œ
- ê° ë‹¨ê³„ëŠ” ìì‹ ì˜ queueë¥¼ ê°€ì§€ê³  ìˆë‹¤.
- callbackì˜ ìœ í˜•ì— ë§ëŠ” queueì— ë“±ë¡ì´ ëœë‹¤.
- ê° ë‹¨ê³„ì—ì„œ ë‹¤ìŒ ë‹¨ê³„ë¡œ ë„˜ì–´ê°€ëŠ” ê²ƒì„ `tick` ì´ë¼ê³  í•œë‹¤.
- ìœ„ 6ë‹¨ê³„ë¥¼ Round-Robin ë°©ì‹ìœ¼ë¡œ ìˆœíšŒí•˜ë©° ë™ì‘í•œë‹¤.

### timers

- timerì™€ ê´€ë ¨ëœ ë¹„ë™ê¸° ì‘ì—…ì„ ê´€ë¦¬í•œë‹¤.
  - setTimeout, setIntervalì— ë“±ë¡ëœ callback
- min-heap ìë£Œêµ¬ì¡° ê¸°ë°˜

### pending callbacks

- ì´ì „ event loop ë‹¨ê³„ê°€ ë°˜ë³µë˜ë©´ì„œ ìˆ˜í–‰ë˜ì§€ ëª»í•œ callbackë“¤ì„ ìŒ“ì•„ë‘ê³  ì‹¤í–‰í•œë‹¤.
- event loopì˜ `pending_queue`ì— ë“¤ì–´ê°€ ìˆëŠ” callbackë“¤ì„ ì‹¤í•¸í•œë‹¤.
  - error handler callbackì´ ì—¬ê¸°ì— ë“±ë¡ëœë‹¤.

### idle, prepare

- ë§¤ tickë§ˆë‹¤ ì‹¤í–‰ë˜ê³ , Node.js ë‚´ë¶€ ê´€ë¦¬ë¥¼ ìœ„í•´ ì‚¬ìš©í•œë‹¤ê³ ë§Œ ì„¤ëª…ë˜ì–´ ìˆë‹¤.
- ëª¨ë“  queueê°€ ë¹„ì–´ìˆìœ¼ë©´ idleì´ ë˜ì–´ tick frequencyê°€ ë–¨ì–´ì ¸ event loop ë‹¨ê³„ê°€ ì²œì²œíˆ ì‹¤í–‰ë˜ë„ë¡ í•˜ëŠ” ìš©ë„?

### poll

- ëŒ€ë¶€ë¶„ì˜ callbackì„ ê´€ë¦¬í•œë‹¤.
- `watcher_queue`ë¥¼ ì´ìš©í•˜ì—¬ ê´€ë¦¬í•œë‹¤.
  - ë¹„ë™ê¸° ì‘ì—…ì´ ì™„ë£Œë˜ì—ˆì„ ê²½ìš°, ìˆœì„œë¥¼ ë³´ì¥í•˜ê¸° ìœ„í•´ í•´ë‹¹ queue ì‚¬ìš©
  - `watcher`ëŠ” FD(file descriptor)ë¥¼ ê°€ì§€ê³  ìˆì–´ OSê°€ FDê°€ ì¤€ë¹„ë˜ì—ˆë‹¤ê³  ì•Œë¦¬ë©´ event loopê°€ í•´ë‹¹í•˜ëŠ” watcherë¥¼ ì°¾ì•„ callbackì„ ì‹¤í–‰í•œë‹¤.

### check

- setImmediate()ë¡œ ë“±ë¡ëœ callbackì„ ê´€ë¦¬í•œë‹¤.

### close callbacks

- close, destroyì™€ ê°™ì€ event íƒ€ì…ì˜ callbackì„ ì²˜ë¦¬í•œë‹¤.

![javascript-runtime](/post-images/javascript/Javascript-EventLoop/4.png)
ğŸ“Œ [ì´ë¯¸ì§€ ì¶œì²˜](https://www.korecmblog.com/node-js-event-loop/)

## Task Queue & Microtask Queue

- Event Loopê°€ ì²˜ë¦¬í•˜ëŠ” callback queueì—ëŠ” ìš°ì„ ìˆœìœ„ì— ë”°ë¥¸ 2 ì¢…ë¥˜ì˜ queueê°€ ì¡´ì¬í•œë‹¤.

### 1. Task Queue

- **setTimeout**, setInterval, setImmediate, requestAnimationFrame, I/O, UI ë Œë”ë§ ë“±ì˜ í•¨ìˆ˜ë“¤ì´ callbackì„ Task queueì— ë„£ëŠ”ë‹¤.

### 2. Microtask Queue

- **Promise**, process.nextTick,Â  Object.observe, MutationObserver ë“±ì˜ í•¨ìˆ˜ë“¤ì´ callbackì„ Microtask queueì— ë„£ëŠ”ë‹¤.

âœ… Event LoopëŠ” Microtask queueì˜ ëª¨ë“  taskë“¤ì„ ì²˜ë¦¬í•œ í›„, Task queueì˜ taskë“¤ì„ ì²˜ë¦¬í•œë‹¤.
